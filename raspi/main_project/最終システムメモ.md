# 2025年度電話自動応答システムのドキュメント
2025年度版の電話自動応答システムについてのトラブルシューティング付き丸わかりパーフェクトガイド

ChatGPTとかAIに丸投げしてもいいけど，こういった先人の残したドキュメントを読んでシステム理解や問題対応とかできると大きく成長できるから活用してくれると嬉しいなって思って岩達が作成しました
## システム構成
### main_projectディレクトリ
* main_project/new_IDR_system.py -> 本体スクリプト
* main_project/.env -> LINEやGeminiのトークンを書きこむ(アップロード厳禁)
* main_project/requirements.txt -> 使用モジュールのリスト
* main_project/system.sh -> システム起動用bashスクリプト
* main_project/output.txt -> tkinter用の保存テキストファイル
### main_project/datasetsディレクトリ
* main_project/datasets/ft_model.bin -> バイナリ形式のfasttext分類モデル
* main_project/datasets/gakusyudata.csv -> 分類モデル用の学習データ元(学習データを調整する場合は.txtではなくてこっち)
* main_project/datasets/school_test.pdf -> Geminiの回答用データ集
* main_project/datasets/train_model.py -> 分類モデル作成スクリプト(本体スクリプトから呼び出しもしているため直接実行しなくても良い)
* main_project/datasets/train.txt -> 分類モデル作成用学習データのテキストファイル
### main_project/sound_filesディレクトリ
* main_project/sound_files/generate/ -> Geminiの回答をgTTSで音声化したファイル用ディレクトリ(中身は空が正常)
* main_project/sound_files/guide/ -> 固定の音声ガイドファイル格納用ディレクトリ(create_guide.pyで生成可能)
* main_project/sound_files/create_guide.py -> 固定の音声ガイドファイル整合性チェックスクリプト(本体スクリプトから呼び出しもしているため直接実行しなくても良い)

## 動作
### セットアップ
* 「main_project」の部分は異なっても良いが，datasets,sound_filesディレクトリなどの構成は揃えないと動作しない
* 必須ファイル，ディレクトリは以下の通り
  * new_IDR_system.py
  * .env
  * requirements.txt
  * system.sh
  * datasets/gakusyudata.csv, schooltest.pdf, train_model.py, train.txt
  * sound_files/generate/
  * sound_files/guide/
  * sound_files/create_guide.py


* モジュールインストール
```sh
# 本体スクリプトのあるディレクトリで端末(terminal)を開いて実行する
# 1.仮想環境の構築
python3 -m venv venv
# 2.仮想環境を起動
source venv/bin/acticate
# 3.モジュールをインストール
pip install -r requirements.txt
```
* モジュールの編集
fasttextモジュールだけはなぜかインストールしただけの状態では正常な動作ができないため

`venv/lib64/python3.11/site-packages/fasttext/FastText.py`

エディタからFastText.pyを開いて，239行目を

`return labels, np.array(probs, copy = False)` → `return labels, np.array(probs)`

### 実行
* 仮想環境構築した時と同じ位置でコマンドを実行
```sh
# 4.仮想環境で実行
python3 new_IDR_system.py
```

## トラブルシューティング
エラーが起きたときのためのいくつかの対処法をまとめる

* ### pyaudioが入らない問題
SpeechRecognitionでマイクを使用するためにもpyaudioが不可欠
```sh
pip install pyaudio
```
とやったときに，「ファイルが見つかりません」のようなエラーが出る可能性がある

このようなときには，
```sh
sudo apt update
sudo apt install -y portaudio19-dev
```
を行うことで不足している可能性のあるヘッダファイルが入りpyaudioをインストールできるようになる

* ### ファイルが見つからない系の問題
1. ディレクトリの構成を再度確認する
```
main_project
├ new_IDR_system.py
├ .env
├ requirements.txt
├ system.sh
├ datasets
│ ├ gakusyudata.csv
│ ├ school_test.pdf
│ ├ train_model.py
│ └ train.txt
└ sound_files
  ├ create_guide.py
  ├ generate
  └ guide
```
ディレクトリ構成が正しくないと存在しないディレクトリ内のファイルを探してしまい，結果として見つからないというエラーが出る

2. 端末(terminal)の実行位置を確認する

端末から本体pyスクリプトを実行する例
```sh
tsuchiya@tsuchiya: ~Desktop/kenkyu/2025-denwa/main_project $ python3 new_IDR_system.py
```
実行位置の違いから不具合が起きる可能性もあるため注意
*  ### return系のエラー
前述の通り，fasttextをインストールしただけではどうしても使用時にreturnの形が誤っていることによるエラーが発生してしまう．また，何かの拍子にモジュールがアップデートされた場合に，スクリプトが再び書き換わってしまい，エラーが起きることもある．

* ### timeout,通信系エラー
このシステムはインターネット接続できていないとモジュールのインポート部分でスタックしてしまう．そのため通信環境は必ず確認する必要がある．

また，GeminiやSpeech Recognition，gTTSはGoogleのサービスに接続する関係でGoogle側のサービス状況も含めて確認が必要になるケースがある．

* ### Geminiのモデルエラー
おのれGoogleと言いたくなるほどに非常に面倒な問題がGeminiにはある．人知れず，Geminiの旧式モデルを足切りする現象が度々起きる．そのような場合は必ず[Gemini APIモデル](<https://ai.google.dev/gemini-api/docs/models?hl=ja>)を確認すること

本体84行目にある`gemini_model = "gemini-2.5-flash-lite"`の部分を適切なモデルに変更させることで対応が可能

そしてもし遭遇したら「<u><b>おのれGoogle</b></u>」と言ってください

## 現在の不具合情報
1. サーボモータが動かない問題

信号線はpi4のGPIO9から出しているから恐らくこの部分は問題ないはず．一方，先代のシステムとは異なり，5V電源をArduinoから取得するようにしているため，この変更した回路部分に不備があって動作していない可能性もある．要考察&検証必須．

2. 音声再生されていない問題

スピーカーに耳を近づけてみたが，スピーカーから音声が出力されていないような気がする．スピーカーの音声出力に関しては，本体の再生ソフトを通してのみ確認したためpyスクリプトからの出力テストと調整が必要と思われる．

3. メイン部分の`while cont_sys:`が異常なループを起こしている問題

ログを辿ると，着信の確認→録音を試みているところから，正常にシリアル通信ができているのは確実である．しかしながら，受話器をおろしても着信を検知した状態が続き録音を繰り返そうとしていることが確認された．この問題はサーボが稼働してコールサインが切れなかったことによる蓄積の影響である可能性がある．そのため，サーボの正常稼働後にこの問題に対するアプローチを行わなければならない．また，現在は1on1での模擬環境となっているが，一つが接続状態の時に別の電話が来た場合はどのような挙動をするのかが不明である点が懸念される．

4. play_sound()の引数

play_sound()の呼び出し側引数があちこち間違っているから修正する

5. 録音後の検証不足

現時点での最重要課題は，不動のサーボ，再生されない音声である．よって以降の分類，非定型のAI処理等までの全体挙動を確認することができていないので，取り急ぎ重要課題の消化が求められる．

## 最後に
ここまで読んでくれていれば，きっとこのシステムのソフト面の大枠をそれなりに理解できていると思うので頑張って続きを頑張って完成させてほしいです．